<!DOCTYPE html>
<html lang="zh-CN" ng-app>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<script src="http://test.eshicon.org/KJ-PROJECT/js/polymer.min.js"></script>
		<script src="http://test.eshicon.org/KJ-PROJECT/js/socket.io-1.0.6.js"></script>
		<script src="http://test.eshicon.org/KJ-PROJECT/js/jquery-2.1.0.js"></script>
		<script src="http://test.eshicon.org/KJ-PROJECT/js/jquery.mobile-1.4.3.js"></script>
		<!--<script src='http://test.eshicon.org/KJ-PROJECT/js/fastclick.js'></script>-->

		<link rel="stylesheet" href="http://test.eshicon.org/KJ-PROJECT/css/jquery.mobile-1.4.3.css" />
		<link rel="shortcut icon" type="iamge/x-icon" href="favicon.ico">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
		<link rel="apple-touch-icon" href="favicon.ico">

		<style>
			div.scroll {
				overflow: auto;
				/*这个的作用是让溢出的<li><div></div></li>能够滑动,不至于在手机上看不全消息*/
			}
			.XL {
				font-size: 125%;
			}
			.L {
				font-size: 110%;
			}
			.sui-btn {
				color: blue;
			}
		</style>

		<script>
			"use strict"

			function get_venues(block_name, space_number) { //blockname 为string ,space number为number
				if (block_name == "A") {
					if (space_number >= 1 && space_number <= 36) {
						//東1
						return 1;
					} else if (space_number >= 37 && space_number <= 52) {
						//東2
						return 2;
					} else if (space_number >= 53 && space_number <= 88) {
						//東3
						return 3;
					};
				} else if (block_name >= "B" && block_name <= "L") {
					//東1
					return 1;
				} else if (block_name >= "M" && block_name <= "Z") {
					//東2
					return 2;
				} else if (block_name >= "ア" && block_name <= "サ") {
					//東3
					return 3;
				} else if (block_name == "シ") {
					if (space_number >= 1 && space_number <= 36) {
						//東4
						return 4;
					} else if (space_number >= 37 && space_number <= 52) {
						//東5							
						return 5;
					} else if (space_number >= 53 && space_number <= 88) {
						//東6
						return 6;
					};
				} else if (block_name >= "ス" && block_name <= "ヌ") {
					//東6
					return 6;
				} else if (block_name >= "ネ" && block_name <= "ミ") {
					//東5
					return 5;
				} else if (block_name >= "ム" && block_name <= "ロ") {
					//東4
					return 4;
				} else if (block_name >= "あ" && block_name <= "な") {
					//西2
					return 2;
				} else if (block_name >= "に" && block_name <= "れ") {
					//西1
					return 1;
				};
			};

			var socket = io.connect("http://157.7.138.169:2333");

			$(function() {

				"use strict"
				//								FastClick.attach(document.body);

				//未登录跳转
				if (localStorage.id != undefined && localStorage.nickname != undefined && localStorage.username != undefined) {
					console.log("logined");
				} else {
					console.log("unlogined,jump!");
					//					 window.location.assign("http://test.eshicon.org/login.html");
				};

				window.csvdata = new Array(); //存储csv数据的一个全局变量。从read-csv.js里入栈。

				console.time("验证队伍与用户");

				socket.emit("main_check_group_server", localStorage.nickname, localStorage.active_group);

				socket.on("main_check_group_client", function(flag, power, is_locked) { //flag:number,1代表加入队伍，0代表没加入队伍;power:string,队伍里的职务；is_lock:number,1为锁定，0为未锁定;
					if (flag == 1) { //true：在服务器里检索到数据，加入了队伍。
						if (is_locked) { //true:给标题加个锁字，输出
							$("title-tag").attr("value", localStorage.active_group + "(锁)");
						} else { //branch:正常输出标题
							$("title-tag").attr("value", localStorage.active_group);
						};

						console.timeEnd("验证队伍与用户");

						localStorage.active_group_power = power;
						localStorage.active_group_item_lock = is_locked;
						console.log(power);
						if (is_locked) { //true:锁定
							console.log("locked");
						} else { //branch:未锁定
							console.log("unlocked");
						};
					} else { //branch:清空无用数据
						$("title-tag").attr("value", "(未选队伍)");
						localStorage.removeItem("active_group");
						localStorage.removeItem("active_group_power");
						localStorage.removeItem("active_group_item_lock");
					};
				});

				window.states = new Object();
				window.states = {
					"circle": {
						"id": "",
						"data": "",
						"items": ""
					},
					"item": {
						"name": "",
						"responsibility": ""
					},
					"group": {
						"member": ""
					}
				};



				//结算时用数据存储,绑定为全局对象
				window.calc_data = new Object();
				window.calc_data = {
					"_date": "",
					"is_sum_all": 0, //1为结算全部，0为结算self
					"result": new Object()
				};

				//读取物品详情/编辑关系,绑定至window作为全局对象
				window.op_details = new Object();
				window.op_details = {

					"otherinfo": new Object(), //存储基于circleid的relation;调用方式:window.op_details.otherinfo[circleid],为0则不存在item,不为0则存在item
					"update_note": function(texts) { //texts,string,一段Note文字
						var note_text = prompt("请输入附注：", texts);
						if (note_text) {
							socket.emit("main_update_note_server", window.states.circle.id, note_text, localStorage.active_group);
							$("#note_in_details").text("附注:" + note_text);
						};
					},
					"read": function(circleid) {
						$("#circle_details_circledata").empty(); //清空原有的内容
						window.states.circle.id = circleid;
						window.states.circle.data = window.op_details[circleid]; //window.op_details[circleid] 为circle里的一行,obj类型

						$("#circle_details_circledata").append("<li><div class=\"XL\">" + window.states.circle.data['i11'] + "</div></li>").append("<li><div class=\"L\">" + window.states.circle.data['circle_id'] + "</div></li>");
						$("#circle_details_circledata").append("<li><div class=\"scroll\">摊位名称：" + window.states.circle.data['i11'] + "</div></li>");
						$("#circle_details_circledata").append("<li><div class=\"scroll\">摊位读法：" + window.states.circle.data['i12'] + "</div></li>");
						$("#circle_details_circledata").append("<li><div class=\"scroll\">摊位作者：" + window.states.circle.data['i13'] + "</div></li>");
						$("#circle_details_circledata").append("<li><div class=\"scroll\">颁布物名：" + window.states.circle.data['i14'] + "</div></li>");
						$("#circle_details_circledata").append("<li><div class=\"scroll\">补足说明：" + window.states.circle.data['i17'] + "</div></li>");
						$("#circle_details_circledata").append('<li><a target="_blank" href=\"' + window.states.circle.data['i15'] + '\">主页链接：' + window.states.circle.data['i15'] + "</a></li>");
						$("#circle_details_circledata").append('<li><div id=\"note_in_details\" onclick=\"window.op_details.update_note(\'' + window.states.circle.data['i18'] + '\')\" class=\"scroll\">附注：' + window.states.circle.data['i18'] + '</div></li>');
						$("#circle_details_circledata").append("<li><div class=\"scroll\">上传用户：" + window.states.circle.data['updater'] + "</div></li>");

						$("#circle_details").page();
						$("#circle_details_circledata").listview("refresh");
						$("#circle_details_set_finished").button("enable");
						if (window.op_details[circleid]['updater'] == localStorage.nickname || localStorage.active_group_power == "leader") {
							$("#circle_delete").button("enable");
						} else {
							$("#circle_delete").button("disable");
						};
						if (window.states.circle.data['i27'] != "finished") {
							$("#circle_details_set_finished").val("设为已完成").button("refresh");
						} else {
							$("#circle_details_set_finished").val("设为未完成").button("refresh");
						};
						$.mobile.changePage("#circle_details");
					}
				};

				//读取circle的item数据,绑定为全局对象
				window.op_items = new Object();
				window.op_items = {
					"now_itemname": "", //存储item edit中对应的item name
					"now_item_responsibility": "",
					"to": 1, //1为返回到items_edit_select,2返回到tools
					"clear_selectmemu": function() {
						$("#items_edit_select").page();
						$("#items_for_select").val("").selectmenu("refresh");
						$("#user_for_select").val("").selectmenu("refresh");
					},
					"read": function(circleid) {
						if (window.op_details.otherinfo) {
							window.states.circle.id = circleid;
							$("#items_list").empty();
							$("#items_for_select").empty().append('<option value=\"\">item名</option>');
							$("#user_for_select").empty().append('<option value=\"\">user名</option>');

							var username_temp = new Object();
							if (window.op_details.otherinfo[circleid][0]) { //不为空
								for (var x in window.op_details.otherinfo[circleid]) {
									var count_items = 0; //总件数计数器
									if (localStorage.active_group_power == "leader" || window.op_details.otherinfo[circleid][x]['responsibility'] == localStorage.nickname || window.op_details.otherinfo[circleid][x][localStorage.nickname]) {
										$("#items_for_select").append('<option value=\"' + x + '\">' + window.op_details.otherinfo[circleid][x]["item_name"] + '</option>');
									};
									$("#items_list").append('<li data-role=\"list-divider\">' + window.op_details.otherinfo[circleid][x]["item_name"] + '(' + window.op_details.otherinfo[circleid][x]["item_price"] + '円)</li>');

									if (window.op_details.otherinfo[circleid][x]['responsibility'] == "") {
										$("#items_list").append('<li data-role=\"listview\"><h1><center>无负责人</center></h1></li>');
									} else {
										$("#items_list").append('<li data-role=\"listview\" onclick=\'alert(\"负责人：' + window.op_details.otherinfo[circleid][x]['responsibility'] + '\")\'><h1><center>' + window.op_details.otherinfo[circleid][x]['responsibility'] + '</center></h1></li>');
									};

									for (var y in window.op_details.otherinfo[circleid][x]) { //循环读取这个item中的对象

										if (y != "circle_id" && y != "item_name" && y != "item_price" && y != "responsibility" && y != "rowid" && window.op_details.otherinfo[circleid][x][y]) {
											if (!username_temp[y]) {
												if (localStorage.active_group_power == "leader" || window.op_details.otherinfo[circleid][x]['responsibility'] == localStorage.nickname || y == localStorage.nickname) {
													$("#user_for_select").append('<option value=\"' + y + '\">' + y + '</option>');
												};
												username_temp[y] = 1;
											};
											var temp = eval('(' + window.op_details.otherinfo[circleid][x][y] + ')');
											count_items += temp['target'];
											$("#items_list").append('<li data-role=\"listview\"><div class=\"scroll\">' + y + window.op_details.otherinfo[circleid][x][y] + '</div></li>');
										};
									};
									$("#items_list").append('<li data-role=\"listview\" onclick=\"window.op_items.join(' + x + ')\"><div class=\"scroll\">共' + count_items + '份</div></li>');
								};
							} else {
								$("#items_list").append('<li data-role=\"listview\"><center>无item</center></li>');
							};

							$("#items").page();
							$("#items_list").listview("refresh");
							$.mobile.changePage("#items");
						} else {
							alert("所有的circle都没有任何item!");
							$.mobile.changePage("#items");
						};
					},
					"join": function(number_in_array) { //number_in_array 类型为 number
							//取得数据，扔进编辑里。
							//							window.states.circle.id = window.states.circle.id;
							window.states.item.name = window.op_details.otherinfo[window.states.circle.id][number_in_array]['item_name'];
							window.states.item.responsibility = window.op_details.otherinfo[window.states.circle.id][number_in_array]['responsibility'];

							//							console.log(window.op_details.otherinfo[window.states.circle.id][number_in_array]); //iteminfo对象

							if (window.op_details.otherinfo[window.states.circle.id][number_in_array][localStorage.nickname] !== null) {
								//转换为对象
								var Obj_my_itemdata = eval('(' + window.op_details.otherinfo[window.states.circle.id][number_in_array][localStorage.nickname] + ')');
								//								console.log(Obj_my_itemdata);
								$("#items_edit_target").val(Obj_my_itemdata['target']);
								$("#items_edit_bought").val(Obj_my_itemdata['bought']);
							} else { //为null
								//不转换为对象
								$("#items_edit_target").val('');
								$("#items_edit_bought").val('');
							};

							$("#items_edit_name").val("").val(window.op_details.otherinfo[window.states.circle.id][number_in_array]['item_name']);
							$("#items_edit_username").val(localStorage.nickname);
							$("#items_edit_price").val("").val(window.op_details.otherinfo[window.states.circle.id][number_in_array]['item_price']);
							$("#item_edit_responsibility").empty().append('<option value=\"\">请选择负责人</option>');
							$("#items_edit").page();
							if (localStorage.active_group_power == "leader" || window.op_details.otherinfo[window.states.circle.id][number_in_array]['responsibility'] == localStorage.nickname) { //if i am leader, i can control every item and relation
								if (window.op_details.otherinfo[window.states.circle.id][number_in_array]) {
									$("#item_edit_responsibility").append('<option value=\"' + window.op_details.otherinfo[window.states.circle.id][number_in_array]['responsibility'] + '\" selected>' + window.op_details.otherinfo[window.states.circle.id][number_in_array]['responsibility'] + '</option>')
									for (var x in window.op_details.otherinfo[window.states.circle.id][number_in_array]) {
										if (x != "item_name" && x != "item_price" && x != "circle_id" && x != "rowid" && x != "responsibility" && window.op_details.otherinfo[window.states.circle.id][number_in_array]['responsibility'] != x) {
											//										console.log(x);
											$("#item_edit_responsibility").append('<option value=\"' + x + '\">' + x + '</option>');
										};
									};
								} else {
									for (var x in window.states.group.member) {
										if (x != "item_name" && x != "item_price" && x != "circle_id" && x != "rowid" && x != "responsibility") {
											//										console.log(x);
											$("#item_edit_responsibility").append('<option value=\"' + x + '\">' + x + '</option>');
										};
									};
								};
								$("#items_edit_price").removeAttr("readonly");
								$("#item_edit_responsibility").selectmenu("enable").selectmenu("refresh");
								$("#item_delete").button("enable");
							} else { //not leader
								$("#items_edit_price").attr("readonly", true);
								$("#item_edit_responsibility").selectmenu("disable").selectmenu("refresh");
								$("#item_delete").button("disable");
							};
							$.mobile.changePage("#items_edit");
						} //join 结束
				};

				//队伍操作,绑定为全局对象
				window.op_group = new Object();
				window.op_group = {
					raw_all_group: new Array(),
					all_group: new Array(),
					my_group: new Array(),
					other_group: new Array(),
					now_group: "",
					now_group_power: "",
					add: function() {
						if ($("#manage_group_add_group_name").val() && $("#manage_group_add_group_introduction").val() && $("#manage_group_add_group_password").val()) {
							var new_group_data = new Object();
							new_group_data = {
								"group_name": $("#manage_group_add_group_name").val(),
								"group_introduction": $("#manage_group_add_group_introduction").val(),
								"group_password": $("#manage_group_add_group_password").val()
							};
							socket.emit("main_manage_group_add_server", new_group_data, localStorage.nickname);
						} else {
							alert("三项信息都不能为空");
						};
					},
					details: function(group_name) {
						window.op_group.now_group = group_name;
						$("#group_members").empty().append("<li><center><h1>队伍成员</h1></center></li>");

						for (var i in window.op_group.raw_all_group) {
							if (window.op_group.raw_all_group[i]["group_name"] == group_name) {
								$("#group_details_change_group_name").val(group_name);
								$("#group_details_change_group_password").val("");
								$("#group_details_change_group_introduction").val(window.op_group.raw_all_group[i]["group_introduction"]);
								$("#group_details_change_group_my_power").val(window.op_group.raw_all_group[i][localStorage.nickname]);
								$("#group_details").page();

								window.op_group.now_group_power = window.op_group.raw_all_group[i][localStorage.nickname];
								window.op_group.now_group_item_lock = window.op_group.raw_all_group[i]['group_item_lock'];

								var lock;
								void

								function() {
									if (window.op_group.now_group_item_lock == "locked") {
										lock = "解锁";
									} else {
										lock = "锁定";
									}
								}();

								$("#button_group_item_lock").val(lock + "item").button("refresh");

								//////锁定无法显示



								switch (window.op_group.raw_all_group[i][localStorage.nickname]) {

									case "leader":
										$(".group_text").attr("readonly", true);
										$(".group_text.group_leader").removeAttr("readonly");
										$(".group_button").button("disable");
										$(".group_button.group_leader").button("enable");
										break;

									case "member":
										$(".group_text").attr("readonly", true);
										$(".group_text.group_member").removeAttr("readonly");
										$(".group_button").button("disable");
										$(".group_button.group_member").button("enable");
										break;

									case null:
										$(".group_text").attr("readonly", true);
										$(".group_text.group_blank").removeAttr("readonly");
										$(".group_button").button("disable");
										$(".group_button.group_blank").button("enable");
										break;
								};
							};

							if (window.op_group.raw_all_group[i]["group_name"] == window.op_group.now_group) {
								for (var x in window.op_group.raw_all_group[i]) {
									if (x != "group_introduction" && x != "group_name" && x != "group_item_lock" && window.op_group.raw_all_group[i][x] != null) {
										if (window.op_group.raw_all_group[i][x] == "leader") {
											$("#group_members").prepend("<li><div class=\"scroll\"><center>" + x + "</center></div></li>");
										} else if (window.op_group.raw_all_group[i][x] == "member") {
											$("#group_members").append("<li><div onclick=\"window.op_group.power_up(\'" + x + "\',\'" + window.op_group.raw_all_group[i]["group_name"] + "\')\" class=\"scroll\"><center>" + x + "</center></li>");
										};
									};
								};
							};
						};
						$("#group_members").prepend("<li><center><h1>队长</h1></center></li>");



						if (window.op_group.now_group == localStorage.active_group) {
							$("#button_active_group").button("disable").val("已设为活跃").button("refresh");
						} else {
							$("#button_active_group").val("设为活跃").button("refresh");
						};
						$("#group_members").listview("refresh");
						$.mobile.changePage("#group_details");
					},
					"power_up": function(username, which_group) {
						if (localStorage.active_group == which_group && localStorage.active_group_power == "leader") {
							var r = confirm("你确定要将" + username + "的权限提升为队长？");
							if (r) {
								socket.emit("main_op_group_powerup", username, which_group);
							};
						};
					}
				};

				//通讯机能

				socket.on("connect", function() {
					$("#message").page();
					$("#recived_message").append("<li><center><div class=\"scroll\">已连接</div></center></li>");
					$("#recived_message").listview("refresh");
				}); //socket.on("connect") ending

				socket.on("main_message_client", function(message) {
					$("#message").page();
					$("#recived_message").append("<li><div class=\"scroll\"><b>" + message + "</b></div></li>");
					$("#recived_message").listview("refresh");
				}); //socket.on("main_message_client", function(message) ending

				socket.on("main_csv_submit_client", function(result) {
					if (result == -1) {
						$("#upload_result").apped("<li><center>服务器异变!请联系suica</center></li>");
					} else if (result == 0) {
						$("#upload_result").append("<li><center>数据库已有此宝物的数据</center></li>");
					} else {
						$("#upload_result").append("<li><center>circle:" + result + "上传成功</center></li>");
					};
					$("#upload_result").listview("refresh");
				});
				//任务推送

				socket.on("main_mission_list_client", function(otherinfo, circleinfo, is_othermission) { //otherinfo是relation数据，circleinfo是circle数据
					//circleinfo有string和object两种类型。string说明已推送过此item的circle信息；object说明没有推送过


					if (is_othermission == 1) { //进其他任务
						$("#all_mission").append('<li><a herf="#circle_details" onclick="window.op_details.read(\'' + circleinfo['circle_id'] + '\')">' + circleinfo['i11'] + '<p>' + circleinfo['i14'] + '</p>' + '<p>作者:' + circleinfo['i13'] + '</p><p>' + circleinfo['circle_id'] + '</p>' + '<p>备注:' + circleinfo['i17'] + '</p></a><a onclick=\"window.op_items.read(\'' + circleinfo['circle_id'] + '\')\">' + '</a></li>');
						$("#all_mission").listview("refresh");
						$("#all_count").text(Number($("#all_count").text()) + 1);
						window.op_details[circleinfo['circle_id']] = circleinfo;
						if (!$.isArray(window.op_details.otherinfo[circleinfo['circle_id']])) { //若不是数组,则初始化为数组
							window.op_details.otherinfo[circleinfo['circle_id']] = new Array();
						};
						window.op_details.otherinfo[circleinfo['circle_id']].push(otherinfo);
					} else { //进完成或未完成的任务
						if (typeof(circleinfo) == "string") { //true:代表已经推送过了；circleinfo里是string形式的circleid
							//已经推送过就说明：window.op_details.otherinfo[circleinfo['i2']]已经是个数组了；不需要再初始化:winndow.op_details.otherinfo[circleinfo] = new Array();
							window.op_details.otherinfo[circleinfo].push(otherinfo);
						} else { //branch:代表没有推送过;circleinfo里是完整的object形式
							if (circleinfo['i27'] == "finished") {
								if (!$.isArray(window.op_details.otherinfo[circleinfo['circle_id']])) { //若不是数组,则初始化为数组
									window.op_details.otherinfo[circleinfo['circle_id']] = new Array();
								};
								window.op_details.otherinfo[circleinfo['circle_id']].push(otherinfo);
								$("#finished").append('<li><a herf="#circle_details" onclick="window.op_details.read(\'' + circleinfo['circle_id'] + '\')" id=\"' + circleinfo['circle_id'] + '\">' + circleinfo['i11'] + '<p>' + circleinfo['i14'] + '</p><p>' + circleinfo['circle_id'] + '</p>' + '<p>作者:' + circleinfo['i13'] + '</p><p>备注:' + circleinfo['i17'] + '</p></a><a onclick=\"window.op_items.read(\'' + circleinfo['circle_id'] + '\')\">' + '</a></li>');
								$("#finished").listview("refresh");
								$("#finished_count").text(Number($("#finished_count").text()) + 1);
								window.op_details[circleinfo['circle_id']] = circleinfo;
							} else {
								if (!$.isArray(window.op_details.otherinfo[circleinfo['circle_id']])) { //若不是数组,则初始化为数组
									window.op_details.otherinfo[circleinfo['circle_id']] = new Array();
								};
								window.op_details.otherinfo[circleinfo['circle_id']].push(otherinfo);
								$("#unfinished").append('<li><a herf="#circle_details" onclick="window.op_details.read(\'' + circleinfo['circle_id'] + '\')" id=\"' + circleinfo['circle_id'] + '\">' + circleinfo['i11'] + '<p>' + circleinfo['i14'] + ' </p><p>' + circleinfo['circle_id'] + '</p>' + '<p>作者:' + circleinfo['i13'] + '</p><p>备注:' + circleinfo['i17'] + '</p>' + '<a onclick=\"window.op_items.read(\'' + circleinfo['circle_id'] + '\')\">' + '</a>' + '</li>');
								$("#unfinished").listview("refresh");
								$("#unfinished_count").text(Number($("#unfinished_count").text()) + 1);
								window.op_details[circleinfo['circle_id']] = circleinfo;
							};
						};

					};

					if (!window.states.group.member && otherinfo) {
						window.states.group.member = otherinfo;
					};

				});
				//修改点4结束
				//输出结算结果

				socket.on("main_calc_client", function(otherinfo, is_could_ouput) { //circleinfo 是不必要的
					for (var x in otherinfo) {
						if (x != "responsibility" && x != "item_name" && x != "item_price" && x != "circle_id" && x != "rowid") { //member		
							if (typeof(window.calc_data.result[x]) == "undefined") {
								window.calc_data.result[x] = new Object();
								window.calc_data.result[x]['pay_to'] = new Object();
								window.calc_data.result[x]['get_from'] = new Object();
							};
							if (typeof(window.calc_data.result[otherinfo['responsibility']]) == "undefined") {
								window.calc_data.result[otherinfo['responsibility']] = new Object();
								window.calc_data.result[otherinfo['responsibility']]['pay_to'] = new Object();
								window.calc_data.result[otherinfo['responsibility']]['get_from'] = new Object();
							};
							var tempObject = eval('(' + otherinfo[x] + ')');
							//								console.log(Number(otherinfo['item_price']));

							if (typeof(window.calc_data.result[x]['pay_to'][otherinfo['responsibility']]) != "number") {
								window.calc_data.result[x]['pay_to'][otherinfo['responsibility']] = 0;
							};
							if (typeof(window.calc_data.result[otherinfo['responsibility']]['get_from'][x]) != "number") {
								window.calc_data.result[otherinfo['responsibility']]['get_from'][x] = 0;
							};
							if (tempObject !== null && tempObject['bought'] !== null && otherinfo['item_price'] !== null) {
								window.calc_data.result[x]['pay_to'][otherinfo['responsibility']] += Number(otherinfo['item_price']) * tempObject['bought'];
								window.calc_data.result[otherinfo['responsibility']]['get_from'][x] += Number(otherinfo['item_price']) * tempObject['bought'];
							};
						};
					};
					if (is_could_ouput) { //true:calc数据已经接受完毕，可以输出结算结果！
						//这里输出结算结果！
						if (window.calc_data.is_sum_all) { //true:display all
							for (var x in window.calc_data.result) {

								$("#calc_result_frame").append('<li data-role=\"list-divider\">' + x + '的结算(' + window.calc_data.result[x]['pay_to'][x] + '円)</li>');
								//									$("#calc_result_frame").append('<li>' + x + '自身购买' + window.calc_data.result[x]['pay_to'][x] + '円</li>');
								$("#calc_result_frame").append('<li><center>' + x + '付款:</center></li>');


								for (var y in window.calc_data.result[x]['pay_to']) { //loop each money receiver
									if (x != y && window.calc_data.result[x]['pay_to'][y]) {
										$("#calc_result_frame").append('<li>' + x + '付给' + y + ' ' + window.calc_data.result[x]['pay_to'][y] + '円</li>');
									};
								};

								$("#calc_result_frame").append('<li><center>' + x + '收款:</center></li>');

								for (var z in window.calc_data.result[x]['get_from']) {
									if (x != z && window.calc_data.result[x]['get_from'][z]) {
										$("#calc_result_frame").append('<li>' + x + '从' + z + '收 ' + window.calc_data.result[x]['get_from'][z] + '円</li>');
									};
								};
							};

						} else { //branch:display self
							$("#calc_result_frame").append('<li><center>你的付款:</center></li>');
							var is_self_output = 0;
							for (var x in window.calc_data.result[localStorage.nickname]['pay_to']) { //loop each money receiver
								console.log(localStorage.nickname + "付给" + x);
								console.log(window.calc_data.result[localStorage.nickname]['pay_to'][x]);

								if (is_self_output == 0 && x != localStorage.nickname) {
									$("#calc_result_frame").append('<li>' + localStorage.nickname + '付给' + x + ' ' + window.calc_data.result[localStorage.nickname]['pay_to'][x] + '円</li>');
									is_self_output = 1;
								};

							};
							is_self_output = 0;
							for (var x in window.calc_data.result[localStorage.nickname]['get_from']) {
								console.log(localStorage.nickname + "拿钱:");
								if (is_self_output == 0 && x != localStorage.nickname) {
									$("#calc_result_frame").append('<li>' + localStorage.nickname + '从' + y + '收' + window.calc_data.result[localStorage.nickname]['get_from'][x] + '円</li>');
									is_self_output = 1;
								};

								console.log(window.calc_data.result[localStorage.nickname]['get_from'][x]);
							};
						};
						//这里不用跳转到calc_result
						$("#calc_result").page();
						$("#calc_result_frame").listview("refresh");
					};
				});

				//队伍推送
				socket.on("main_select_group_client", function(result) {

					window.op_group.raw_all_group.push(result);
					window.op_group.all_group.push({
						"group_name": result['group_name'],
						"group_introduction": result['group_introduction'],
						"my_power": result[localStorage.nickname]
					});

					if (result[localStorage.nickname]) {

						window.op_group["my_group"].push({

							"group_name": result["group_name"],
							"group_introduction": result["group_introduction"],
							"my_power": result[localStorage.nickname]

						});

						$("#recived_group").append("<li><a onclick=\"window.op_group.details(\'" + result["group_name"] + "\')\">" + result["group_name"] + "(" + result[localStorage.nickname] + ")" + "<p>" + result["group_introduction"] + "</p>" + "</a></li>");

					} else {

						window.op_group["other_group"].push({
							"group_name": result["group_name"],
							"my_power": ""
						});

						$("#recived_group").append("<li><a onclick=\"window.op_group.details(\'" + result["group_name"] + "\')\">" + result["group_name"] + "(未加入此队伍)" + "<p>" + result["group_introduction"] + "</p>" + "</a></li>");

					};

					$("#select_group").page();
					$("#recived_group").listview("refresh");

				}); //socket.on("main_select_group_client") ending

				socket.on("alert_client", function(text_number, type_number) {

					if (type_number == 1) {

						switch (text_number) {

							case 1:
								alert("加入此队伍成功!");
								$("#select_group_refresh").trigger("click"); //队伍刷新
								break;

							case 2:
								alert("退出此队伍成功!");
								$("#select_group_refresh").trigger("click"); //队伍刷新
								break;

							case 3:
								alert("解散此队伍成功!");
								$("#select_group_refresh").trigger("click"); //队伍刷新
								break;

							case 4:
								alert("变更保存成功!");
								break;

							case 5:
								alert("队伍创建成功!");
								$("#select_group_refresh").trigger("click"); //队伍刷新
								break;

							case 6:
								alert("item添加成功!");
								$("#add_item_reset").trigger("click");
								break;

							case 7:
								alert("circle添加成功!");
								$("#add_circle_reset").trigger("click");
								break;

							case 8:
								alert("成功将该circle设置为已完成/未完成!");
								break;

							case 9:
								alert("成功设置此用户为负责人!");
								break;
							case 10:
								alert("编辑item成功!");
								break;
							case 11:
								alert("删除成功!");
								break;

							case 12:
								alert("拉取队伍成员出现了异常错误……请重新登录后再试！"); //这个两边都是错误，故意为之
								break;

							case 13:
								alert("note更新成功!");
								break;
							case 14:
								alert("提权成功!");
								$("#turn_to_select_group").trigger("click");
								break;
							case 15:
								alert("锁定/解锁成功!");
								$("#turn_to_select_group").trigger("click");
								break;

						}

					} else if (type_number == 0) {

						switch (text_number) {

							case 1:
								alert("加入此队伍失败.请确认密码!");
								break;

							case 2:
								alert("未知错误,退出此队伍失败.\n请刷新或者重新登录之后再试!");
								break;

							case 3:
								alert("未知错误,解散此队伍失败.\n请刷新或者重新登录之后再试!");
								break;

							case 4:
								alert("未知错误,变更保存失败.\n请不要尝试输入过于奇怪的字符或刷新之后再试!");
								break;
							case 5:
								alert("队伍创建失败.\n请检查是否重名或者使用汉字/英文字母的队伍名!");
								break;

							case 6:
								alert("item添加失败.\n1.请检查当前活跃队伍中的列表中是否不存在此circle!\n若不存在,请先添加circle!\n2.请检查当前活跃队伍中的列表中是否已存在此item名!\n若已存在,请更换item名!");
								break;

							case 7:
								alert("circle添加失败.\n请检查当前活跃队伍中的列表中是否已存在此circle!\n若已存在,则不必再次添加!");
								break;

							case 8:
								alert("将该circle设置为已完成/设置为未完成失败!请检查circle或队伍是否已被删除!");
								break;

							case 9:
								alert("设置此用户为负责人失败!请检查此人是否已经退出队伍!");
								break;

							case 10:
								alert("编辑item失败!请刷新查看此item是否已被删除!");
								break;
							case 11:
								alert("删除失败!原因未知！");
								break;

							case 12:
								alert("拉取队伍成员出现了异常错误……请重新登录后再试！");
								break;

							case 13:
								alert("note更新出现错误！……你输入了奇怪的字符？");
								break;
							case 14:
								alert("提权失败!请确认该用户是否是member权限或者是否是队伍成员!");
								//								$("#turn_to_select_group").trigger("click");
								break;
							case 15:
								alert("锁定/解锁失败!");
								$("#turn_to_select_group").trigger("click");
								break;

						};

					};

				});

				socket.on("main_list_member_client", function(memberinfo) { //memberinfo 即为groups中的一行;obj类型
					for (var x in memberinfo) {
						if (x != "group_name" && x != "group_introduction" && x != "group_password" && x != "group_item_lock") {
							if (memberinfo[x]) { //x在队伍里
								$("#add_item_responsibility").append('<option value=\"' + x + '\">' + x + '</option>').selectmenu("refresh");
							};
						};
					};
				});

				//掉线
				socket.on("disconnect", function() {
					$("#recived_message").append("<br /><li><center>连接异常关闭</center></li>");
					$("#message").page();
					$("#recived_message").listview("refresh");
					console.log("与服务器的连接已关闭.刷新页面以重新连接.");
				}); //socket.on("disconnect", function() ending

				//消息发送机能
				$("#sent_message").keypress(function(event) {
					if (event.which == 13) {
						event.preventDefault();
						socket.emit("main_message_server", localStorage.nickname + ":" + $("#sent_message").val());
						$("#sent_message").val("");
					}; //if ending
				}); //$("#sent_message").keypress(function(event) ending

				$("#button_message_send").click(function() {
					socket.emit("main_message_server", localStorage.nickname + ":" + $("#sent_message").val());
					$("#sent_message").val("");
				}); //$("#button_message_send").click(function() ending
				//清除消息
				$("#button_message_clear").click(function() {
					$("#recived_message").empty();
					$("#recived_message").listview("refresh");
				}); //$("#button_message_clear").click() ending
				//CSV上传
				$("#upload_csv").click(function() {
					var r = confirm("确认为\"" + localStorage.active_group + "\"上传CSV?");
					if (r) {
						if (window.csvdata != "") {
							$("#upload_result").empty();
							console.log("上传开始");
							for (var pointer = 0; pointer < window.csvdata.length; pointer++) {
								switch (window.csvdata[pointer][0]) {
									case "Circle":
										// if (window.csvdata[pointer].length == 29 || window.csvdata[pointer].length == 27) {
										//1203-1
										if (window.csvdata[pointer][5] != "×" && window.csvdata[pointer][6] != "×" && window.csvdata[pointer][7] != "×") {
											if (window.csvdata[pointer][21] == "0") {
												window.csvdata[pointer][21] = "a";
											} else if (window.csvdata[pointer][21] == "1") {
												window.csvdata[pointer][21] = "b";
											};
											//i6 i7 i8 i9 i22
											if ((Number(window.csvdata[pointer][8]) < 10) && window.csvdata[pointer][8].length == 1) {
												window.csvdata[pointer][8] = "0" + window.csvdata[pointer][8];
											};

											if (window.csvdata[pointer][7] >= "Ａ" && window.csvdata[pointer][7] <= "Ｚ") {
												window.csvdata[pointer][7] = String.fromCharCode(window.csvdata[pointer][7].charCodeAt(0) - 65248);
											};

											var circle_id = window.csvdata[pointer][5] + window.csvdata[pointer][6] + get_venues(window.csvdata[pointer][7], Number(window.csvdata[pointer][8])) + window.csvdata[pointer][7] + window.csvdata[pointer][8] + window.csvdata[pointer][21];

											socket.emit("main_csv_submit_server", window.csvdata[pointer], localStorage.active_group, localStorage.nickname, circle_id);
										} else {
											$("#upload_result").append("<li><div class=\"scroll\">错误:请确认此行数据中是否含有“×”号" + window.csvdata[pointer] + "</div></li>");
										};

										// } else {
										// 	console.log(window.csvdata[pointer].length);
										// 	$("#upload_result").append("<li><div class=\"scroll\">错误:请确认此行数据中是否含有意外逗号;或csv文件字段数不为22或27" + window.csvdata[pointer] + "</div></li>");
										// };
										break;

									case "Header":
										break;

									case "Color":
										break;

									default:
										// console.log(pointer);
										if (pointer + 1 == window.csvdata.length && window.csvdata[pointer].length == 1) { //	行尾空格,不报错.
										} else {
											$("#upload_result").append("<li><div class=\"scroll\">错误:" + window.csvdata[pointer] + "</div></li>");
										};
										break;
								};
							};
						} else {
							alert("请选择文件");
						};
					};
				});

				//刷新与数据获取

				$("#refresh_data").click(function() {

					window.op_details.otherinfo = new Object();

					if (localStorage.active_group) {

						$("#unfinished").empty();
						$("#finished").empty();
						$("#all_mission").empty(); //载入新数据之前清空旧数据
						$("#unfinished_count").text(0);
						$("#finished_count").text(0);
						$("#all_count").text(0);
						socket.emit("main_mission_list_server", localStorage.nickname, localStorage.active_group);

					} else {

						alert("尚未选择活跃队伍~");

					};

				});

				//上传edit后的数据
				$("#items_edit_save").click(function() {
					if ($("#items_edit_target").val() && $("#items_edit_bought").val() && $("#items_edit_price").val()) {
						var edit_data_obj = new Object();
						edit_data_obj = {
							"bought": Number($("#items_edit_bought").val()),
							"target": Number($("#items_edit_target").val())
						};
						var edit_data_string = JSON.stringify(edit_data_obj);
						//						console.log("对象字符串化为" + edit_data_string);
						var edit_price_number = Number($("#items_edit_price").val());
						socket.emit("main_edit_data_server", edit_data_string, edit_price_number, $("#items_edit_name").val(), $("#items_edit_username").val(), localStorage.active_group);
					} else {
						alert("请完成所有表单!");
					};
				});

				//结算:自身
				$("#calc_start").click(function() {
					if (localStorage.active_group) {
						var r = confirm("您确定要查看" + localStorage.active_group + "的结算吗？\n" + "结算的日期为" + $("#calc_when").val());
						if (r) {
							var q = confirm("输出所有人的结算？");
							if (q) {
								window.calc_data.is_sum_all = 1;
							} else {
								window.calc_data.is_sum_all = 0;
							};

							window.calc_data.income_count = 0;
							window.calc_data.outcome_count = 0; // 初始化三个count变量
							window.calc_data._date = $("#calc_when").val(); //把结算的时间扔进去

							socket.emit("main_calc_server", localStorage.nickname, localStorage.active_group, $("#calc_when").val());

							$.mobile.changePage("#calc_result");
						};
					} else {
						alert("请选择活跃队伍！");
					};
				});

				///////////////第二期新增代码/////////////////

				$("#turn_to_select_group").click(function() {
					$("#recived_group").empty().append("<li><center><h1>所有的队伍</h1></center></li>");
					//清空队伍信息
					window.op_group["raw_all_group"] = [];
					window.op_group["all_group"] = [];
					window.op_group["my_group"] = [];
					socket.emit("main_select_group_server", localStorage.nickname);
					$.mobile.changePage("#select_group");
				});

				$("#turn_to_manage_group").click(function() {
					is_turning = 0;
					socket.emit("main_manage_group_server", localStorage.nickname);
				});

				$("#manage_group_add_save").click(function() {
					window.op_group.add();
					$.mobile.changePage("#select_group");
				});

				$("#select_group_refresh").click(function() {
					$("#recived_group").empty().append("<li><center><h1>所有的队伍</h1></center></li>").listview("refresh");

					//清空队伍信息
					window.op_group["raw_all_group"] = [];
					window.op_group["all_group"] = [];
					window.op_group["my_group"] = [];
					socket.emit("main_select_group_server", localStorage.nickname);
					$.mobile.changePage("#select_group");
				});

				$("#button_group_item_lock").click(function() {
					if ($("#button_group_item_lock").val() == "锁定item") {
						//锁定
						socket.emit("main_op_group_lock_server", window.op_group.now_group, 0);
						if (localStorage.active_group == window.op_group.now_group) {
							$("title-tag").attr("value", localStorage.active_group + "(锁)");
							localStorage.active_group_item_lock = "locked";
						};
						$("#button_group_item_lock").val("解锁item").button("refresh");
					} else {
						//解锁
						if (localStorage.active_group == window.op_group.now_group) {
							$("title-tag").attr("value", localStorage.active_group);
							localStorage.active_group_item_lock = "";
						};
						socket.emit("main_op_group_lock_server", window.op_group.now_group, 1);
						$("#button_group_item_lock").val("锁定item").button("refresh");
					};
				});

				$("#button_join_group").click(function() {
					if ($("#group_details_change_group_password").val()) {
						socket.emit("main_op_group_server", localStorage.nickname, 1, window.op_group.now_group, $("#group_details_change_group_password").val(), "");
					} else {
						alert("请输入队伍密码!");
						$("#group_details_change_group_password").focus();
					};
				});

				$("#button_exit_group").click(function() {
					var r = confirm("你确定要退出此队伍?");
					if (r) {
						if (localStorage.active_group == window.op_group.now_group) {
							$("title-tag").attr("value", "(未选队伍)");
							localStorage.active_group = "";
							localStorage.active_group_power = "";
							localStorage.active_group_item_lock = "";
						};
						socket.emit("main_op_group_server", localStorage.nickname, 2, window.op_group.now_group, "", "", "");
					};
				});

				$("#button_delete_group").click(function() {
					var r1 = confirm("你确定要解散此队伍?");
					if (r1) {
						var r2 = confirm("真的要解散此队伍吗?所有的数据都会被永久删除!");
						if (r2) {
							socket.emit("main_op_group_server", localStorage.nickname, 3, window.op_group.now_group, "", "", "");
							if (localStorage.active_group == window.op_group.now_group) {
								$("title-tag").attr("value", "(未选队伍)");
								localStorage.active_group = "";
								localStorage.active_group_power = "";
								localStorage.active_group_item_lock = "";
							};
						};
					};
				});

				$("#turn_to_manage_group_add").click(function() {
					$("#manage_group_add_group_name").val("");
					$("#manage_group_add_group_introduction").val("");
					$("#manage_group_add_group_password").val("");
					$.mobile.changePage("#manage_group_add");
				});

				$("#group_details_save").click(function() {
					if ($("#group_details_change_group_name").val() && $("#group_details_change_group_password").val() && $("#group_details_change_group_introduction").val()) {
						socket.emit("main_op_group_server", localStorage.nickname, 4, window.op_group.now_group, $("#group_details_change_group_password").val(), $("#group_details_change_group_introduction").val(), $("#group_details_change_group_name").val());
					} else {
						alert("请填写所有的信息!");
					};
				});

				$("#button_active_group").click(function() {
					localStorage.active_group = window.op_group.now_group;
					localStorage.active_group_power = window.op_group.now_group_power;
					localStorage.active_group_item_lock = window.op_group.now_group_item_lock;
					if (localStorage.active_group_item_lock) {
						$("title-tag").attr("value", localStorage.active_group + "(锁)");
					} else {
						$("title-tag").attr("value", localStorage.active_group);
					};
					alert("成功设置\"" + localStorage.active_group + "\"为活跃队伍");
					$("#button_active_group").button("disable").val("已设为活跃").button("refresh");
				});

				$("#turn_to_add_item").click(function() {
					if (localStorage.active_group) {
						if (localStorage.active_group_item_lock != "locked" || localStorage.active_group_power == "leader") {
							$("#add_item").page();
							$("#add_item_responsibility").empty().append('<option value=\"\">请选择负责人</option>').selectmenu("refresh");
							if (localStorage.active_group_power == "leader") {
								$("#add_item_responsibility").selectmenu("enable").selectmenu("refresh");
								socket.emit("main_list_member_server", localStorage.active_group);
							} else {
								$("#add_item_responsibility").selectmenu("disable").selectmenu("refresh");
							};

							$("#add_item_circle_id").val(window.states.circle.id);
							$("#add_item_name").val("");
							$("#add_item_price").val("");
							$("#add_item_number").val("");
							$("#add_item_copy_num").val(1).slider("refresh");
							$.mobile.changePage("#add_item");
						} else {
							alert("队长锁定了item的编辑.")
						};

					} else {
						alert("请选择活跃队伍!");
					};
				});

				$("#add_item_reset").click(function() {
					var r = confirm("确认重置这个表单?");
					if (r) {
						$("#add_item_name").val("");
						$("#add_item_price").val("");
						$("#add_item_number").val("");
						$("#add_item_copy_num").val(1).slider("refresh");
					};
				});

				$("#add_item_upload").click(function() {
					var r = confirm("确认为" + localStorage.active_group + "添加item?");
					if (r) {
						if ($("#add_item_name").val() && $("#add_item_price").val() && $("#add_item_circle_id").val() && $("#add_item_copy_num").val()) {
							if (!isNaN(Number($("#add_item_price").val())) && Number($("#add_item_price").val()) >= 0) {
								socket.emit("main_add_item_server", $("#add_item_name").val(), $("#add_item_price").val(), $("#add_item_circle_id").val(), $("#add_item_copy_num").val(), localStorage.nickname, localStorage.active_group, $("#add_item_responsibility").val());
							} else {
								alert("价格不能小于，且不含任何非数字字符!");
							};
						} else {
							alert("请填写所有的信息!");
						};
					};
				});

				$("#turn_to_add_circle").click(function() {
					if (localStorage.active_group) {
						$("#add_circle").page();
						$("#add_circle_date").val("日").selectmenu("refresh");
						$("#add_circle_area").val("東").selectmenu("refresh");
						$("#add_circle_block_name").val("");
						$("#add_circle_space_number").val("");
						$("#add_circle_name").val("");
						$("#add_circle_number").val("");
						$("#add_circle_author").val("");
						$("#add_circle_space_set").val("a").selectmenu("refresh");
						$.mobile.changePage("#add_circle");
					} else {
						alert("请选择活跃队伍!");
					};
				});

				$("#add_circle_reset").click(function() {

					var r = confirm("确认重置这个表单?");

					if (r) {

						$("#add_circle_date").val("日").selectmenu("refresh");
						$("#add_circle_area").val("東").selectmenu("refresh");
						$("#add_circle_block_name").val("");
						$("#add_circle_space_number").val("");
						$("#add_circle_name").val("");
						$("#add_circle_number").val("");
						$("#add_circle_author").val("");
						$("#add_circle_space_set").val("a").selectmenu("refresh");

					};
				});

				$("#add_circle_upload").click(function() {
					var r = confirm("确认为队伍\"" + localStorage.active_group + "\"添加circle?");
					if (r) {

						if ($("#add_circle_date").val() && $("#add_circle_area").val() && $("#add_circle_block_name").val() && $("#add_circle_space_number").val() && $("#add_circle_name").val() && $("#add_circle_author").val() && $("#add_circle_space_set").val()) {

							if (Number($("#add_circle_space_number").val()) < 10 && $("#add_circle_space_number").val().length == 1) { //补齐0

								$("#add_circle_space_number").val("0" + $("#add_circle_space_number").val());

							};


							if ($("#add_circle_block_name").val() >= "Ａ" && $("#add_circle_block_name").val() <= "Ｚ") {

								$("#add_circle_block_name").val(String.fromCharCode($("#add_circle_block_name").val().charCodeAt(0) - 65248));
								//把全角字符的unicode编码转换为对应半角字符的unicode码
							};

							var circle_id = $("#add_circle_date").val() + $("#add_circle_area").val() + get_venues($("#add_circle_block_name").val(), Number($("#add_circle_space_number").val())) + $("#add_circle_block_name").val() + $("#add_circle_space_number").val() + $("#add_circle_space_set").val();

							socket.emit("main_add_circle_server", $("#add_circle_date").val(), $("#add_circle_area").val(), $("#add_circle_block_name").val(), $("#add_circle_space_number").val(), $("#add_circle_name").val(), $("#add_circle_author").val(), $("#add_circle_space_set").val(), localStorage.active_group, localStorage.nickname, circle_id); //1116

						} else {

							alert("请填写所有的信息!");

						};

					};

				});

				$("#circle_details_set_finished").click(function() {
					if ($("#circle_details_set_finished").val() == "设为已完成") {
						var r = confirm("确认将circle" + window.states.circle.id + "设为已完成?");
						if (r) {
							socket.emit("main_circle_finish_server", 1, window.states.circle.id, localStorage.active_group);
							$("#circle_details_set_finished").val("设为未完成").button("refresh");
							//这里偷工减料了……为了赶时间，直接在emit之后改变按钮的value
						};
					} else {
						var r = confirm("确认将circle" + window.states.circle.id + "设为未完成?");
						if (r) {
							socket.emit("main_circle_finish_server", 0, window.states.circle.id, localStorage.active_group);
							$("#circle_details_set_finished").val("设为已完成").button("refresh");
						};
					};
				});

				$("#item_edit_responsibility").change(function() {
					$("#item_edit_responsibility").selectmenu("refresh");
					socket.emit("main_change_responsibility_server", $("#item_edit_responsibility").val(), window.states.item.name, localStorage.active_group);
				});

				$("#items_edit_select_assure").click(function() {
					if ($("#items_for_select").val() && $("#user_for_select").val()) {
						$("#items_edit").page();
						var pureobj_info = eval('(' + window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()][$("#user_for_select").val()] + ')');

						window.states.item.name = window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['item_name']; //11.12
						window.states.item.responsibility = window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['responsibility'];


						$("#items_edit_name").val("").val(window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['item_name'])
						$("#items_edit_username").val($("#user_for_select").val());
						$("#items_edit_price").val("").val(window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['item_price']);

						$("#items_edit_target").val("");
						$("#items_edit_bought").val("");

						$("#item_edit_responsibility").empty().append('<option value=\"\">请选择负责人</option>');

						if (localStorage.active_group_power == "leader") { //if i am leader, i can control every item and relation

							if (window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]) {
								if (window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['responsibility']) { //如果有负责人，输出；没有就不输出
									$("#item_edit_responsibility").append('<option value=\"' + window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['responsibility'] + '\" selected>' + window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['responsibility'] + '</option>')
								};
								for (var x in window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]) {
									if (x != "item_name" && x != "item_price" && x != "circle_id" && x != "rowid" && x != "responsibility" && window.op_details.otherinfo[window.states.circle.id][$("#items_for_select").val()]['responsibility'] != x) {
										$("#item_edit_responsibility").append('<option value=\"' + x + '\">' + x + '</option>');
									};
								};
							} else {
								for (var x in window.states.group.member) {
									if (x != "item_name" && x != "item_price" && x != "circle_id" && x != "rowid" && x != "responsibility") {
										console.log("1" + x);
										$("#item_edit_responsibility").append('<option value=\"' + x + '\">' + x + '</option>');
									};
								};
							};
							$("#item_edit_responsibility").selectmenu("enable").selectmenu("refresh");
							$("#item_delete").button("enable");
						} else { //not leader
							$("#item_edit_responsibility").selectmenu("disable").selectmenu("refresh");
							$("#item_delete").button("disable");
						};

						if (pureobj_info != null) {
							$("#items_edit_target").val(pureobj_info['target']);
							$("#items_edit_bought").val(pureobj_info['bought']);
						};
						$.mobile.changePage("#items_edit");
					} else {
						alert("请选择item和user!");
					};
				});

				$("#logout").click(function() {
					var r = confirm("你确定要退出?");
					if (r) {
						var active_group = localStorage.active_group;
						var active_group_power = localStorage.active_group_power;
						localStorage.clear();
						localStorage.active_group = active_group;
						localStorage.active_group_power = active_group_power;
						window.location.assign("http://test.eshicon.org/login.html");

					};

				});

				$("#circle_delete").click(function() {
					if (localStorage.active_group_power == "leader" || localStorage.nickname == window.states.circle.data['updater']) {
						var r = confirm("你确定删除id为" + window.states.circle.id + "的circle吗?\n这会删除这个circle所包含的一切item");
						var q = confirm("真的确定吗？");
						if (r && q) {
							socket.emit("main_circle_delete_server", window.states.circle.id, localStorage.active_group);
						};
					} else {
						alert("请确认你有权限删除此circle");
					};

				});

				$("#item_delete").click(function() {
					if (localStorage.active_group_power == "leader" || localStorage.nickname == window.states.item.responsibility) {
						var r = confirm("你确定删除名为" + window.states.item.name + "的item吗?");
						var q = confirm("真的确定吗？");

						if (r && q) {
							socket.emit("main_item_delete_server", window.states.item.name, localStorage.active_group);
						};
					} else {
						alert("请确认你是否有权限删除此Item！\n你需要是目前活跃队伍的leader或是此item的负责人！");
					};

				});

				$("#add_new_item_in_detail").click(function() {
					$("#turn_to_add_item").trigger("click");
				});

				$("#add_new_item_in_itemlist").click(function() {
					//					window.states.circle.id = window.states.circle.id;
					$("#add_new_item_in_detail").trigger("click");
				});

			}); //$(function) ending
		</script>

	</head>

	<body>

		<polymer-element name="title-tag" attributes="value">
			<template>
				{{value}}
			</template>
			<script>
				Polymer('title-tag', {
					// initialize the element's model
					ready: function() {
						this.value = "正在连接！";
					}
				});
			</script>
		</polymer-element>

		<!--模块化分割线！-->

		<div data-role="page" id="mission">
			<div data-role="header" data-position="fixed">

				<h1><title-tag></title-tag></h1>

				<div data-role="button" class="ui-btn-right sui-btn">
					<a href="#tools" data-role="button" data-icon="grid" data-transition="slide">工具</a>
				</div>
				<div data-role="button" class="ui-btn-left">
					<input type="button" id="refresh_data" data-icon="refresh" value="刷新" />
				</div>
			</div>

			<div data-role="content">

				<div data-role="collapsible" data-collapsed="false">
					<h4>未完成的任务<span id="unfinished_count" class="ui-li-count">0</span></h4>
					<ul id="unfinished" data-role="listview" data-inset="true" data-filter="true" data-filter-placeholder="在未完成的任务中搜索..."></ul>
				</div>

				<div data-role="collapsible">
					<h4>已完成的任务<span id="finished_count" class="ui-li-count">0</span></h4>
					<ul id="finished" data-role="listview" data-inset="true" data-filter="true" data-filter-placeholder="在已完成的任务中搜索..."></ul>
				</div>

				<div data-role="collapsible">
					<h4>无关的circle<span id="all_count" class="ui-li-count">0</span></h4>
					<ul id="all_mission" data-role="listview" data-inset="true" data-filter="true" data-filter-placeholder="在全部任务中搜索..."></ul>
				</div>

			</div>

			<div data-role="footer" data-position="fixed">
				<div data-role="navbar" id="shift_to_message">
					<ul>
						<li><a href="#" data-icon="info" class="ui-state-persist">任务</a>
						</li>
						<li><a id="turn_to_message" href="#message" data-icon="star" data-transition="fade">消息</a>
					</ul>
				</div>
			</div>
		</div>

		<div data-role="page" id="message">
			<div data-role="header">
				<!--<h1 id="connect_flag">消息</h1>-->
				<h1><title-tag></title-tag></h1>
				<div data-role="button" class="ui-btn-left">
					<input type="button" id="button_message_clear" value="清空" data-role="button" data-icon="alert">
				</div>
			</div>

			<div data-role="content">
				<ul id="recived_message" data-role="listview" data-inset="false">
				</ul>
				<br />
				<input type="text" id="sent_message">
				<input type="button" id="button_message_send" value="发送消息">
				<br />


			</div>

			<div data-role="footer" data-position="fixed">
				<div data-role="navbar" id="shift_to_mission">
					<ul>
						<li><a href="#mission" data-icon="info" data-transition="fade">任务</a>
						</li>
						<li><a href="#" data-icon="star" class="ui-state-persist">消息</a>
						</li>
					</ul>
				</div>
			</div>
		</div>

		<div data-role="page" id="tools">
			<div data-role="header">
				<h1>工具</h1>
				<a href="#mission" data-role="button" data-icon="back" data-transition="slide" data-direction="reverse">返回</a>

			</div>

			<div data-role="content">
				<input type="button" id="turn_to_select_group" value="队伍管理" />
				<input type="button" id="turn_to_add_item" value="登录新宝物">
				<input type="button" id="turn_to_add_circle" value="登录新摊位">
				<a href="#input_csv" data-role="button" data-transition="slide">导入CSV文件</a>
				<br />
				<hr>
				<br />
				<a href="#calc_setting" data-role="button">结算</a>
				<a href="#about" data-role="button" data-transition="slide">关于</a>
				<a id="logout" data-role="button" data-theme="b">退出当前帐号</a>
			</div>
		</div>

		<div data-role="page" id="select_group">
			<div data-role="header">
				<h1>队伍选择</h1>

				<div data-role="button" class="ui-btn-left">
					<a href="#tools" data-role="button" data-icon="back" data-direction="reverse" data-transition="slide">返回</a>
				</div>

				<div data-role="button" class="ui-btn-right">
					<input type="button" id="select_group_refresh" value="刷新" data-icon="alert">
				</div>
			</div>

			<div data-role="content">
				<ul id="recived_group" data-role="listview" data-inset="true" data-filter="true" data-filter-placeholder="搜索队伍...">
					<li>
						<center>
							<h1>所有的队伍</h1>
						</center>
					</li>
				</ul>
			</div>

			<div data-role="footer" data-position="fixed">
				<div data-role="navbar">
					<ul>
						<li><a id="turn_to_manage_group_add" data-icon="info" class="ui-btn">创建新队伍!</a>
						</li>
					</ul>
				</div>
			</div>

		</div>

		<div data-role="page" id="group_details">
			<div data-role="header">
				<h1>队伍详情</h1>

				<div data-role="button" class="ui-btn-left">
					<a href="#select_group" data-role="button" data-icon="back" data-direction="reverse" data-transition="slide">返回</a>
				</div>

				<div data-role="button" class="ui-btn-right">
					<input type="button" class="group_button group_leader" id="group_details_save" value="保存更改" data-icon="alert" disabled>
				</div>
			</div>

			<div data-role="content">
				<div data-role="fieldcontain">
					<label for="group_details_change_group_name">队伍名:</label>
					<input type="text" class="group_text group_leader" name="name" id="group_details_change_group_name" value="" placeholder="队伍的名字" readonly>
				</div>

				<div data-role="fieldcontain">
					<label for="group_details_change_group_introduction">队伍介绍:</label>
					<input type="text" class="group_text group_leader" id="group_details_change_group_introduction" value="" placeholder="随便写点吧" readonly>
				</div>

				<div data-role="fieldcontain">
					<label for="group_details_change_group_password">密码:</label>
					<input type="password" class="group_text group_leader group_blank" id="group_details_change_group_password" value="" placeholder="输入/变更密码" readonly>
				</div>

				<div data-role="fieldcontain">
					<label for="group_details_change_group_my_power">你的权限:</label>
					<input type="text" name="text" id="group_details_change_group_my_power" value="" placeholder="" readonly>
				</div>

				<ul id="group_members" data-role="listview" data-inset="true">
					<li>
						<center>
							<h1>队伍成员</h1>
						</center>
					</li>
				</ul>

				<input type="button" class="group_button group_member group_leader" id="button_active_group" value="设为活跃" disabled>
				<input type="button" class="group_button group_leader" id="button_group_item_lock" value="锁定item" disabled>
				<input type="button" class="group_button group_blank" id="button_join_group" value="加入此队伍" disabled>
				<input type="button" class="group_button group_member" id="button_exit_group" value="退出此队伍" disabled>
				<input type="button" class="group_button group_leader" id="button_delete_group" value="解散此队伍" data-theme="b" disabled>
			</div>

		</div>

		<div data-role="page" id="manage_group_add">
			<div data-role="header">
				<h1>创建新队伍</h1>
				<div data-role="button" class="ui-btn-left">
					<a href="#select_group" data-role="button" data-icon="back" data-direction="reverse" data-transition="slide">返回</a>
				</div>

				<div data-role="button" class="ui-btn-right">
					<input type="button" id="manage_group_add_save" value="保存" data-icon="alert">
				</div>
			</div>

			<div data-role="content">

				<div data-role="fieldcontain">
					<label for="name">队伍名:</label>
					<input type="text" name="name" id="manage_group_add_group_name" value="" placeholder="队伍的名字">
				</div>

				<div data-role="fieldcontain">
					<label for="text">队伍介绍:</label>
					<input type="text" name="text" id="manage_group_add_group_introduction" value="" placeholder="随便写点吧">
				</div>

				<div data-role="fieldcontain">
					<label for="password">密码:</label>
					<input type="text" name="text" id="manage_group_add_group_password" value="" placeholder="加入队伍时所需要的密码">
				</div>

			</div>

		</div>

		<div data-role="page" id="add_item">
			<div data-role="header">
				<h1>登录新的宝物</h1>
				<a onclick="history.back()" data-role="button" data-icon="back" data-transition="slide" data-direction="reverse">返回</a>
				<div data-role="button" class="ui-btn-right">
					<input type="button" id="add_item_reset" value="重置" data-role="button" data-icon="alert" class="ui-btn-right">
				</div>
			</div>

			<div data-role="content">
				<div data-role="fieldcontain">
					<label for="add_item_name">item名</label>
					<input type="text" id="add_item_name" value="" placeholder="宝物的名字">
				</div>

				<div data-role="fieldcontain">
					<label for="add_item_price">价格</label>
					<input type="text" id="add_item_price" value="" placeholder="円/份">
				</div>

				<div data-role="fieldcontain">
					<label for="add_item_circle_id">摊位地址</label>
					<input type="text" id="add_item_circle_id" value="" placeholder="如：日东6シ01a">

				</div>

				<div data-role="fieldcontain">
					<label for="add_item_copy_num">自身需求份数</label>
					<input type="range" id="add_item_copy_num" value="1" min="0" max="30">
				</div>

				<div data-role="fieldcontain">
					<select id="add_item_responsibility" data-native-menu="false" disabled="">
						<option value="">选择负责人</option>
					</select>
				</div>
				<input type="button" id="add_item_upload" value="上传信息" />

			</div>

		</div>

		<div data-role="page" id="add_circle">
			<div data-role="header">
				<h1>登录新摊位</h1>
				<a onclick="history.back()" data-role="button" data-icon="back" data-transition="slide" data-direction="reverse">返回</a>
				<div data-role="button" class="ui-btn-right">
					<input type="button" id="add_circle_reset" value="重置" data-role="button" data-icon="alert" class="ui-btn-right">
				</div>
			</div>

			<div data-role="content">

				<fieldset data-role="fieldcontain">
					<!-- i6 -->
					<label for="add_circle_date">参加曜日</label>
					<select id="add_circle_date" data-native-menu="false">
						<option value="日">第一日 日曜日</option>
						<option value="月">第二日 月曜日</option>
						<option value="火">第三日 火曜日</option>
					</select>
				</fieldset>

				<fieldset data-role="fieldcontain">
					<!-- i7 -->
					<label for="add_circle_area">配置地区</label>
					<select id="add_circle_area" data-native-menu="false">
						<option value="東">東</option>
						<option value="西">西</option>
					</select>
				</fieldset>

				<div data-role="fieldcontain">
					<!-- i8 -->
					<label for="add_circle_block_name">ブロック名</label>
					<input type="text" id="add_circle_block_name" value="" placeholder="A~Z/ア~ロ/あ～れ">
				</div>

				<div data-role="fieldcontain">
					<!-- i9 -->
					<label for="add_circle_space_number">スペース番号</label>
					<input type="text" id="add_circle_space_number" value="" placeholder="">
				</div>

				<div data-role="fieldcontain">
					<!-- i11 -->
					<label for="add_circle_name">サークル名</label>
					<input type="text" id="add_circle_name" value="">
				</div>

				<div data-role="fieldcontain">
					<!-- i13 -->
					<label for="add_circle_author">執筆者名</label>
					<input type="text" id="add_circle_author" value="" placeholder="">
				</div>

				<div data-role="fieldcontain">
					<!-- i22 -->
					<label for="add_circle_space_set">スペース配置</label>
					<select id="add_circle_space_set" name="" data-native-menu="false">
						<option value="a">a</option>
						<option value="b">b</option>
					</select>
				</div>



				<input type="button" id="add_circle_upload" value="上传信息" />

			</div>

		</div>

		<div data-role="page" id="input_csv">
			<div data-role="header">
				<h1>导入CSV</h1>
				<a href="#tools" data-role="button" data-icon="back" data-transition="slide" data-direction="reverse">返回</a>
				<div data-role="button" class="ui-btn-right">
					<input type="button" id="upload_csv" value="上传" data-icon="arrow-u">
				</div>
			</div>

			<div data-role="content">

				<form id="form_upload_csv">
					<label for="csvFileInput">
						<strong>CSV File:</strong>
					</label>
					<input type="file" id="csvFileInput" onchange="handleFiles(this.files)" accept=".csv">
				</form>
				<center>～上传之前请转换为UTF-8编码上传,否则产生乱码!～</center>
				<center>～请不要修改CSV文件的内容,直接上传即可!～</center>
				<center>上传格式以本页面要求为准</center>
				<center>～建议使用chrome for windows～</center>

				<br />
				<ul id="upload_result" data-role="listview" data-inset="true"></ul>
			</div>

		</div>

		<div data-role="page" id="circle_details">
			<div data-role="header">
				<h1>circle详情</h1>
				<a href="#mission" data-role="button" data-icon="back" data-transition="fade">返回</a>
			</div>

			<div data-role="content">
				<ul id="circle_details_circledata" data-role="listview" data-inset="true"></ul>
				<ul id="circle_details_otherinfo" data-role="listview" data-inset="true"></ul>

				<input type="button" id="add_new_item_in_detail" value="新增此circle的item" />
				<input type="button" id="circle_details_set_finished" value="设为已完成" disabled="" />
				<input type="button" id="circle_delete" value="从队伍里删除此circle" data-theme="b" disabcircle_id />

			</div>
		</div>

		<div data-role="page" id="items">
			<div data-role="header">
				<h1>items</h1>
				<a href="#mission" data-role="button" data-icon="back">返回</a>
			</div>

			<div data-role="content">
				<ul id="items_list" data-role="listview" data-inset="true">
				</ul>
				<input type="button" value="新增此circle的item" id="add_new_item_in_itemlist" />
			</div>

			<div data-role="footer" data-position="fixed">
				<div data-role="navbar">
					<ul>
						<li>
							<a href="#items_edit_select" data-rel="dialog" data-icon="info" class="ui-btn" onclick="window.op_items.clear_selectmemu()">编辑</a>
						</li>
					</ul>
				</div>
			</div>
		</div>

		<div data-role="page" id="items_edit_select">
			<div data-role="content">
				<br />
				<br />
				<br />
				<select id="items_for_select" data-native-menu="false">
				</select>
				<br />
				<select id="user_for_select" data-native-menu="false">
				</select>
				<br />
				<br />
				<br />

				<div class="ui-grid-a">
					<div class="ui-block-a">
						<a href="#items" data-role="button">取消</a>
					</div>
					<div class="ui-block-b">
						<input id="items_edit_select_assure" type="button" value="确认" />
					</div>
				</div>

				<br />
				<br />

			</div>
		</div>


		<div data-role="page" id="items_edit">
			<div data-role="header">
				<h1>编辑</h1>
				<a data-rel="dialog" data-role="button" data-icon="back" onclick="window.op_items.clear_selectmemu();history.back()">返回</a>
				<div data-role="button" class="ui-btn-right">
					<input type="button" id="items_edit_save" value="保存" data-icon="alert">
				</div>
			</div>

			<div data-role="content">

				<div data-role="fieldcontain">
					<label for="items_edit_name">item名</label>
					<input type="text" id="items_edit_name" value="" readonly="">
				</div>
				<div data-role="fieldcontain">
					<label for="items_edit_username">user名</label>
					<input type="text" id="items_edit_username" value="" readonly="">
				</div>
				<div data-role="fieldcontain">
					<label for="items_edit_price">价格:円</label>
					<input type="text" id="items_edit_price" value="" placeholder="勿恶意更改价格" readonly="">
				</div>
				<div data-role="fieldcontain">
					<label for="items_edit_target">目标数:</label>
					<input type="text" id="items_edit_target" value="" placeholder="必填">
				</div>
				<div data-role="fieldcontain">
					<label for="items_edit_bought">已得数:</label>
					<input type="text" id="items_edit_bought" value="" placeholder="必填">
				</div>

				<select id="item_edit_responsibility" data-native-menu="false">
					<option value="">请选择负责人</option>
				</select>

				<input type="button" id="item_delete" value="删除此item" data-theme="b" disabled="" />

			</div>

		</div>

		<div data-role="page" id="calc_setting">
			<div data-role="header">
				<h1>结算设置</h1>
				<a href="#tools" data-role="button" data-icon="back">返回</a>
			</div>

			<div data-role="content">

				<div data-role="fieldcontain">
					<center>结算哪天的?</center>
					<br />
					<select name="calc_when" id="calc_when" data-native-menu="false">
						<!--mikoto-->
						<!--在正式使用的时候，把上边这个value里的“金”这个换成“日”-->
						<option value="日">第一日 日</option>
						<option value="月">第二日 月</option>
						<option value="火">第三日 火</option>
						<option value="233">全部三天</option>
						<option value="金">测试用：金</option>
					</select>
					<br />
					<input type="button" value="结算开始！" id="calc_start" />

				</div>

			</div>

		</div>

		<div data-role="page" id="calc_result">
			<div data-role="header">
				<h1>结算结果</h1>
				<a href="#tools" data-role="button" data-icon="back">返回</a>
			</div>

			<div data-role="content">

				<ul id="calc_result_frame" data-inset="true" data-role="listview">
					<!--<li>
					</li>-->
				</ul>

			</div>
		</div>

		<div data-role="page" id="about">
			<div data-role="header">
				<h1>关于</h1>
				<div data-role="button" class="ui-btn-left">
					<a href="#tools" data-role="button" data-icon="back" data-transition="slide" data-direction="reverse">返回</a>
				</div>
			</div>

			<div data-role="content">
				<br />
				<center>工事中~</center>
				<br />
				<center>ver dev 1.0</center>
				<br />
				<center>这个版本主要的工作就是代码重构与优化。</center>
				<br />
				<hr />
				<br />
				<center> <a href="http://test.eshicon.org/request.html" target="_blank">BUG汇报请点这里~自动新窗口打开哟~</a>
				</center>
				<br />
				<!--<center>code by suica</center>-->
				<!--<center>感谢:</center>
				<center>Katsuragi Mikoto 的帮助</center>
				<center>Testarossa 的意见</center>
				<center>和其他所有给我帮助的各位!</center>-->
			</div>
		</div>

	</body>

	<script src="http://test.eshicon.org/KJ-PROJECT/js/read-csv.js"></script>



</html>