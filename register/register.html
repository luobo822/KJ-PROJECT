<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">   

		<title>KJ PROJECT C86 &rsaquo; 注册</title>

	  <script src="https://cdn.socket.io/socket.io-1.0.6.js"></script>
		<script src="http://test.eshicon.org/KJ-PROJECT/js/jquery-2.1.0.js"></script>
		<script src="http://test.eshicon.org/KJ-PROJECT/js/jquery.md5.js" ></script>
		<script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

		<link rel="stylesheet" href="http://suica.eshicon.org/wp-admin/css/my-frame-css.css"> 
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css">
		
    <script>

     $(function(){

//激活页面上所有的tooltip       

      $("[data-toggle='tooltip']").tooltip(); 

//网页载入时强制focus到用户名框      

			$("#user_name").focus();

//定义标记

      var is_username_checked = 0; //重名检测的结果
      var is_connected = 0; //是否与服务器成功连接

//定义正则表达式

			var character = RegExp("[\u4e00-\u9fa5]|[\u3040-\u309F]|[\u30A0-\u30FF]"); //中片平检测
      var blank = RegExp("\u0020"); //空白检测

//定义全局函数
      
      var temp_old = "";
      var temp_new = "";

      function is_changed(obj){ //判断对象的val()使是否改变,且在第一次调用的时候会返回0
          if (temp_old == "") {
	          temp_old = obj.val();
          }else {
            temp_new = obj.val();
          };	
          if (temp_new == temp_old) {
          	return 0; //unchanged
          }else {
          	return 1; //changed
          };
      };

//重名反馈机能与数据提交机能

      var socket = io.connect("http://157.7.138.169:2333");

      socket.on("connect", function () {
        
        is_connected = 1; //已连接

        $("#connect_flag").val("已连接");

        socket.on("reg_check_username_client", function(check) {
          // $("#debug").val(check);
          is_username_checked = check;
					if (check) {
						$("#user_name").attr("data-original-title","用户名可以使用");
						$("#user_name").tooltip("show");
					};
				}); 

				socket.on("reg_submit_client", function(data){
          if (data.id != "0") {
					   console.log("id:" + data.id);
					   localStorage.setItem("id",data.id);
					   console.log("nickname:" + data.nickname);
					   localStorage.setItem("nickname",data.nickname);
          };
				});

        socket.on("disconnect", function() {
          alert("对不起,与服务器的连接异常断开.\n服务器正在维护,请稍后注册!");
          is_connected = 0; //未连接
        });

      }); //socket.on("connect", function () {}) ending

//定义提示框事件

			$("#user_name").blur(function(){
        if ($("#user_name").val() == "") {
	        	$("#user_name").focus();
            $("#user_name").tooltip("show");
        }
			  else if (blank.exec($("#user_name").val())) {
                $("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","用户名不可以含有空格");
								$("#user_name").focus();
						  } 
			  else if (character.exec($("#user_name").val())) {
                $("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","用户名不可以含有汉字或假名或棒子文");
								$("#user_name").focus();
						  } 
        else if ($("#user_name").val().length < 3) {
								$("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","用户名长度小于3，长度应大于等于3");
								$("#user_name").focus();
			        } 
				else if (!is_connected) {
								$("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","未与服务器连接,无法注册");
								$("#user_name").focus();
							}
        else{ //即服务器连接正常、用户名本地检测合法的情况下，才进行重名检测
	          if (is_username_checked) { //一切正常则允许focus到下一输入框
		           $("#user_name").tooltip("destroy");
				       is_username_checked = 0;
	          }else{
	          	if (is_changed($("#user_name")) == 1) {
				          socket.emit("reg_check_username_server",$("#user_name").val()); //传参:用户名
									$("#user_name").tooltip("show");
									$("#user_name").attr("data-original-title","正在检测是否重名...");
									$("#user_name").focus();
	          	};
	          };
        }; //if ending
      }); //$("#user_name").blur() ending

			$("#user_password").focus(function(){
        if (($("#user_password_confirm").val() != $("#user_password").val()) && ($("#user_password_confirm").val() != "")) 
		        {
	            $("#user_password").attr("data-original-title","密码不相同");
	            $("#user_password").tooltip("show");
	          };
      });
			
			$("#user_password").blur(function(){
        if ($("#user_password").val() == "") {
		            $("#user_password").tooltip("show");
		            $("#user_password").attr("data-original-title","密码不能为空");
		            $("#user_password").focus();
        }
        else if ($("#user_password").val().length < 4) {
								$("#user_password").attr("data-original-title","密码长度小于4，长度应大于等于4");
								$("#user_password").tooltip("show");
								$("#user_password").focus();
			        }
        else if (character.exec($("#user_name").val())) {
                $("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","用户名不可以含有汉字");
								$("#user_name").focus();
						  }
			  else if (blank.exec($("#user_name").val())) {
                $("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","用户名不可以含有空格");
								$("#user_name").focus();
						  }
	      else{
	          $("#user_password").tooltip("destroy");
	      }; //if ending
      }); //$("#user_password").blur() ending

			$("#user_password_confirm").blur(function(){
        if ($("#user_password_confirm").val() == "") {
            $("#user_password_confirm").tooltip("show");
            $("#user_password_confirm").focus();
        }else if ($("#user_password_confirm").val() != $("#user_password").val()) 
			        {
		            $("#user_password").focus();
		            $("#user_password_confirm").attr("data-original-title","密码不相同");
		          }
        else{
	          $("#user_password_confirm").tooltip("destroy");
        }; //if ending
      }); //$("#user_password_confirm").blur() ending

      $("#user_nickname").blur(function(){
        if ($("#user_nickname").val() == "") {
            $("#user_nickname").tooltip("show");
            $("#user_nickname").attr("data-original-title","昵称不能为空~别人通过昵称认出你");
            $("#user_nickname").focus();
        }
			  else if (blank.test($("#user_name").val())) {
                $("#user_name").tooltip("show");
								$("#user_name").attr("data-original-title","昵称不可以含有空格");
								$("#user_name").focus();
						  }
        else{
	          $("#user_nickname").tooltip("destroy");
        }; //if ending
      }); //$("#user_nickname").blur() ending

      $("#security_question").blur(function(){
        if ($("#security_question").val() == "") {
            $("#security_question").tooltip("show");
            $("#security_question").attr("data-original-title","请输入你要回答的密保问题");
            $("#security_question").focus();
        }
        else{
	          $("#security_question").tooltip("destroy");
        }; //if ending
      }); //$("#security_question").blur() ending

      $("#input_security_question").blur(function(){
        if ($("#input_security_question").val() == "") {
            $("#input_security_question").tooltip("show");
            $("#input_security_question").attr("data-original-title","请务必解答你自己的密保问题");
            $("#input_security_question").focus();
        }
        else{
	          $("#input_security_question").tooltip("destroy");
	          if ($("#user_name").val() && $("#user_password").val() && $("#user_password_confirm").val() && $("#user_nickname").val() && $("#security_question").val() && $("#input_security_question").val()) {
		           $("#register").attr("data-original-title","开始战斗吧!");
							 $("#register").tooltip("show");
	          };
        }; //if ending
      }); //$("#input_security_question").blur() ending

//提交表单
			$("#register").click(function(){
				if ($("#user_name").val() && $("#user_password").val() && $("#user_password_confirm").val() && $("#user_nickname").val() && $("#security_question").val() && $("#input_security_question").val()) {

			      var clientdata = new Object();
			      clientdata = {
						    username:$("#user_name").val(),
			          password:$.md5($("#user_password").val()),
			          email:$("#user_email").val(),
			          qq:$("#user_qq").val(),
			          nickname:$("#user_nickname").val(),
			          squestions:$("#security_question").val(),
			          isquestions:$("#input_security_question").val(),
			          id:$.md5($.md5($("#user_password").val())+$("#user_name").val())
					  };
		        socket.emit("reg_submit_server",clientdata); //传参:clientdata对象
				}else{
								$("#register").attr("data-original-title","必填项目不可以留空~");
								$("#register").tooltip("show");
				};
			});

		}); //$(function(){} ending
    
    
    </script>


  </head>

	
<body class="login login-action-login wp-core-ui  locale-zh-cn">

<div id="login">
		<h1><a href="#" title="基于萌与爱">KJ PROJECT</a></h1>
		<p class="message register">为协同作战注册</p>

			<form name="registerform" id="registerform">

<!-- <p>debug</p> -->

<!-- <input type="text" id="debug" value=""> -->
<!-- <br> -->
<!-- flag -->
<!-- <input type="text" id="connect_flag" value=""> -->
				<p>
					<label for="user_name">用户名<br>
						<input type="text" name="user_name" id="user_name" class="input" size="20" data-toggle="tooltip" data-original-title="必填,长度至少为3,允许英文字母、数字、下划线,不能包含空格、汉字、假名、棒子文" data-placement="top" />
					</label>
				</p>

				<p>
					<label for="user_password">密码<br>
						<input type="password" name="user_password" id="user_password" class="input" size="20" data-toggle="tooltip" data-original-title="必填,长度至少为4,允许英文字母、数字、下划线,不能包含空格、汉字、假名、棒子文" data-placement="top" />
					</label>
				</p>

				<p>
					<label for="user_password_confirm">确认密码<br>
						<input type="password" name="user_password_confirm" id="user_password_confirm" class="input" size="20" data-toggle="tooltip" data-original-title="必填,请再次输入密码" data-placement="top" />
					</label>
				</p>

				<p>
					<label for="user_email">电子邮件<br>
					  <input type="text" name="user_email" id="user_email" class="input" size="25" data-toggle="tooltip" data-original-title="非必填,你的邮箱地址" data-placement="top"/>
					</label>
				</p>

				<p>
					<label for="user_qq">QQ号码<br>
					  <input type="text" name="user_qq" id="user_qq" class="input" size="25" data-toggle="tooltip" data-original-title="非必填,你的QQ号码" data-placement="top"/>
					</label>
				</p>
					
				<p>
					<label for="user_nickname">昵称<br>
					  <input type="text" name="user_nickname" id="user_nickname" class="input" size="25" data-toggle="tooltip" data-original-title="必填,建议使用已对他人公开的昵称,便于他人认出你，不能包含空格" data-placement="top" />
					</label>
				</p>

				<p>
					<label for="security_question">输入密保问题<br>
					  <input type="text" name="security_question" id="security_question" class="input" size="25" data-toggle="tooltip" data-original-title="必填,你自定义的密保问题,用来找回密码" data-placement="top" />
					</label>
				</p>
					
				<p>
					<label for="input_security_question">回答密保问题<br>
						<input type="text" name="input_security_question" id="input_security_question" class="input" size="25" data-toggle="tooltip" data-original-title="必填,解答你自己的密保问题,并牢记答案" data-placement="top" />
					</label>
				</p>

				<br><br>

				<p class="submit"><input type="button" class="btn btn-block btn-lg btn-success" value="注册" id="register" data-toggle="tooltip" data-original-title="注册！然后开始战斗吧！！" data-placement="top" /></p>
				
				<br><br><hr>
				
				<p id="nav" align="center">
					<a href="#">登录</a>
				</p>
				
			</form>
</div>
</body>
</html>